{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
.dashboard-container {
    padding: 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.dashboard-header h1 {
    margin: 0;
    color: #333;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.quick-stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-stat-card.contacts {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.quick-stat-card.waitlist {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.quick-stat-card.leads {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.quick-stat-card.conversions {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.quick-stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
}

.quick-stat-card .value {
    font-size: 32px;
    font-weight: bold;
    margin: 0;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-container h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.chart-wrapper {
    position: relative;
    height: 300px;
    margin-top: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.stat-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.stat-numbers {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-weight: 500;
    color: #666;
}

.stat-value {
    font-weight: bold;
    color: #007bff;
    font-size: 1.1em;
}

.recent-activity {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    max-height: 500px;
    overflow-y: auto;
}

.recent-activity h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.activity-item {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item:hover {
    background: #f8f9fa;
}

.activity-info {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.activity-subtitle {
    font-size: 12px;
    color: #666;
}

.activity-meta {
    text-align: right;
    font-size: 12px;
    color: #999;
}

.activity-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    margin-left: 8px;
}

.badge-contact { background: #f5576c; color: white; }
.badge-waitlist { background: #4facfe; color: white; }
.badge-lead { background: #43e97b; color: white; }
.badge-conversion { background: #fee140; color: #333; }

.quick-actions {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.quick-actions h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.action-button {
    display: block;
    padding: 12px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    text-align: center;
    transition: background 0.3s;
}

.action-button:hover {
    background: #0056b3;
    color: white;
    text-decoration: none;
}

.growth-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 8px;
}

.growth-positive {
    background: #d4edda;
    color: #155724;
}

.growth-negative {
    background: #f8d7da;
    color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Dashboard Overview</h1>
        <div>
            <span>Growth: </span>
            <span class="growth-indicator {% if growth_rate >= 0 %}growth-positive{% else %}growth-negative{% endif %}">
                {% if growth_rate >= 0 %}+{% endif %}{{ growth_rate }}%
            </span>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat-card contacts">
            <h3>Today's Contacts</h3>
            <p class="value">{{ todays_submissions.contacts }}</p>
        </div>
        <div class="quick-stat-card waitlist">
            <h3>Today's Waitlist</h3>
            <p class="value">{{ todays_submissions.waitlist }}</p>
        </div>
        <div class="quick-stat-card leads">
            <h3>Today's Leads</h3>
            <p class="value">{{ todays_submissions.leads }}</p>
        </div>
        <div class="quick-stat-card conversions">
            <h3>Pending Items</h3>
            <p class="value">{{ pending_items.total }}</p>
        </div>
    </div>

    <!-- Charts and Activity -->
    <div class="dashboard-grid">
        <!-- Left Column: Charts -->
        <div>
            <!-- Submission Trends Line Chart -->
            <div class="chart-container">
                <h3>Submission Trends (Last 30 Days)</h3>
                <div class="chart-wrapper">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Source Distribution Pie Chart -->
            <div class="chart-container" style="margin-top: 20px;">
                <h3>Source Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>

            <!-- Status Breakdown Bar Chart -->
            <div class="chart-container" style="margin-top: 20px;">
                <h3>Status Breakdown</h3>
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Column: Activity & Actions -->
        <div>
            <!-- Recent Activity -->
            <div class="recent-activity">
                <h3>Recent Activity</h3>
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-title">
                            {{ activity.title }}
                            <span class="activity-badge badge-{{ activity.type }}">{{ activity.type|title }}</span>
                        </div>
                        <div class="activity-subtitle">{{ activity.subtitle }}</div>
                    </div>
                    <div class="activity-meta">
                        <div>{{ activity.timestamp|date:"M d, H:i" }}</div>
                        <a href="{{ activity.url }}" style="font-size: 11px; color: #007bff;">View â†’</a>
                    </div>
                </div>
                {% empty %}
                <p style="color: #999; text-align: center; padding: 20px;">No recent activity</p>
                {% endfor %}
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions" style="margin-top: 20px;">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <a href="{% url 'admin:contacts_contactsubmission_changelist' %}" class="action-button">View Contacts</a>
                    <a href="{% url 'admin:waitlist_waitlistentry_changelist' %}" class="action-button">View Waitlist</a>
                    <a href="{% url 'admin:leads_lead_changelist' %}" class="action-button">View Leads</a>
                    <a href="{% url 'admin:newsletter_newslettersubscription_changelist' %}" class="action-button">View Newsletter</a>
                    <a href="{% url 'admin:analytics_conversion_changelist' %}" class="action-button">View Conversions</a>
                    <a href="{% url 'admin:analytics_pageview_changelist' %}" class="action-button">View Analytics</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Contact Submissions</h3>
            <div class="stat-numbers">
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ contact_stats.total }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">New:</span>
                    <span class="stat-value">{{ contact_stats.new }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Week:</span>
                    <span class="stat-value">{{ contact_stats.this_week }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Spam:</span>
                    <span class="stat-value">{{ contact_stats.spam }}</span>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h3>Waitlist Entries</h3>
            <div class="stat-numbers">
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ waitlist_stats.total }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pending:</span>
                    <span class="stat-value">{{ waitlist_stats.pending }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Approved:</span>
                    <span class="stat-value">{{ waitlist_stats.approved }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Onboarded:</span>
                    <span class="stat-value">{{ waitlist_stats.onboarded }}</span>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h3>Leads</h3>
            <div class="stat-numbers">
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ lead_stats.total }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">New:</span>
                    <span class="stat-value">{{ lead_stats.new }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Qualified:</span>
                    <span class="stat-value">{{ lead_stats.qualified }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Converted:</span>
                    <span class="stat-value">{{ lead_stats.converted }}</span>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h3>Conversion Statistics</h3>
            <div class="stat-numbers">
                <div class="stat-item">
                    <span class="stat-label">Total Conversions:</span>
                    <span class="stat-value">{{ conversion_stats.total_conversions }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today:</span>
                    <span class="stat-value">{{ conversion_stats.conversions_today }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Week:</span>
                    <span class="stat-value">{{ conversion_stats.conversions_week }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Conversion Rate:</span>
                    <span class="stat-value">{{ conversion_stats.lead_conversion_rate }}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Value (Week):</span>
                    <span class="stat-value">${{ conversion_stats.conversion_value_week|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h3>Top Sources - Waitlist</h3>
            <div class="stat-numbers">
                {% for source in top_sources.waitlist %}
                <div class="stat-item">
                    <span class="stat-label">{{ source.source|title }}:</span>
                    <span class="stat-value">{{ source.count }}</span>
                </div>
                {% empty %}
                <div class="stat-item">No data</div>
                {% endfor %}
            </div>
        </div>

        <div class="stat-card">
            <h3>Top Sources - Leads</h3>
            <div class="stat-numbers">
                {% for source in top_sources.leads %}
                <div class="stat-item">
                    <span class="stat-label">{{ source.lead_source|title }}:</span>
                    <span class="stat-value">{{ source.count }}</span>
                </div>
                {% empty %}
                <div class="stat-item">No data</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Submission Trends Line Chart
const trendsData = {{ submission_trends|safe }};
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: trendsData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Contacts',
            data: trendsData.map(d => d.contacts),
            borderColor: 'rgb(245, 87, 108)',
            backgroundColor: 'rgba(245, 87, 108, 0.1)',
            tension: 0.4
        }, {
            label: 'Waitlist',
            data: trendsData.map(d => d.waitlist),
            borderColor: 'rgb(79, 172, 254)',
            backgroundColor: 'rgba(79, 172, 254, 0.1)',
            tension: 0.4
        }, {
            label: 'Leads',
            data: trendsData.map(d => d.leads),
            borderColor: 'rgb(67, 233, 123)',
            backgroundColor: 'rgba(67, 233, 123, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Source Distribution Pie Chart
const sourceData = {{ source_distribution|safe }};
const sourceCtx = document.getElementById('sourceChart').getContext('2d');
const sourceLabels = Object.keys(sourceData);
const sourceValues = Object.values(sourceData);

new Chart(sourceCtx, {
    type: 'pie',
    data: {
        labels: sourceLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1).replace('_', ' ')),
        datasets: [{
            data: sourceValues,
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
            }
        }
    }
});

// Status Breakdown Bar Chart
const statusData = {{ status_breakdown|safe }};
const statusCtx = document.getElementById('statusChart').getContext('2d');

// Prepare data for bar chart
const allStatuses = new Set();
Object.values(statusData).forEach(modelStatuses => {
    Object.keys(modelStatuses).forEach(status => allStatuses.add(status));
});

const statusLabels = Array.from(allStatuses);
const contactCounts = statusLabels.map(s => statusData.contacts[s] || 0);
const waitlistCounts = statusLabels.map(s => statusData.waitlist[s] || 0);
const leadCounts = statusLabels.map(s => statusData.leads[s] || 0);

new Chart(statusCtx, {
    type: 'bar',
    data: {
        labels: statusLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
        datasets: [{
            label: 'Contacts',
            data: contactCounts,
            backgroundColor: 'rgba(245, 87, 108, 0.8)'
        }, {
            label: 'Waitlist',
            data: waitlistCounts,
            backgroundColor: 'rgba(79, 172, 254, 0.8)'
        }, {
            label: 'Leads',
            data: leadCounts,
            backgroundColor: 'rgba(67, 233, 123, 0.8)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
